<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ログイン / Login</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/layui/2.6.8/css/layui.css">
    <link rel="stylesheet" href="/assets/css/appTheme.css">


</head>

<body>
    <div class="top-container ">

        <div class="header-box" data-key="login">

        </div>
        <form class="layui-form" action="">
            <div class="layui-form-item">
                <label class="layui-form-label">Language</label>
                <div class="layui-input-block">
                    <input type="radio" name="language" value="en" title="English" lay-filter="languageRadio">
                    <input type="radio" name="language" value="ja" title="日本" lay-filter="languageRadio">
                </div>
            </div>
        </form>

        <div class="layui-container main-container " id="main-content">




            <button class="layui-btn layui-btn-primary layui-btn-fluid" 　 onclick="redirectToFaceAuthPage()" data-lang
                data-key="faceLogin"></button>

            <form class="layui-form" style="margin-top: 20px;">
                <div class="layui-form-item">
                    <label class="layui-form-label" data-key="username"></label>
                    <div class="layui-input-block">
                        <input 
                         type="text" 
                         name="email"
                         id="email"
                         required lay-verify="required" 
                         placeholder="" 
                         class="layui-input" 
                         lay-reqtext ="Email cannot be empty"
                         data-key="emailPlaceHolder">
                    </div>
                </div>

                <div class="layui-form-item">
                    <label class="layui-form-label" data-key="password"></label>
                    <div class="layui-input-block">
                        <input type="password" 
                        name="password" 
                        id="password" 
                        required lay-verify="required"
                        lay-reqtext ="Password cannot be empty"
                        class="layui-input">
                    </div>
                </div>

                <div class="layui-form-item">
                    <div style="display: flex; justify-content: space-between; gap: 4%;">
                        <div style="flex: 1;">
                            <button 
                            class="layui-btn layui-btn-normal layui-btn-fluid" 
                            id="loginBtn" 
                            onclick="onLogIn()"
                            lay-submit
                            lay-filter = "loginBtn"
                                
                            data-key="login">ログイン</button>
                        </div>
                        <div style="flex: 1;">
                            <button class="layui-btn layui-btn-normal layui-btn-fluid"
                                onclick="redirectToFaceRegistrationPage()" data-key="faceRegister"></button>
                        </div>
                    </div>
                </div>
            </form>

            <p style="text-align: center; margin-top: 10px;">
                <a href="#" style="text-decoration: underline;" data-key="register"
                    onclick="redirectToRegisterPage()"></a>

            </p>
            <p style="text-align: center; margin-top: 10px;">
                <a href="#" style="text-decoration: underline;" data-key="forgetPassword"
                    onclick="alert('under developement')">パスワードをお忘れの場合は、こちらをクリック</a>

            </p>

        </div>

    </div>

    <!-- Error Page (Hidden by Default) -->
    <div class="error-container" id="error-page">
        <div class="error-icon">&#9888;</div>
        <div class="error-title">Error!</div>
        <div class="error-message" id="error-message">We encountered an issue while processing your request. Please try
            again later.</div>
        <button class="layui-btn layui-btn-primary" id="backBtn" onclick="redirectToLoginPage()">Back</button>
    </div>

    <div class="success-container" id="success-page">
        <div class="success-icon">&#10004;</div>
        <div class="success-title">Success!</div>
        <div class="success-message" id="success-message">Authentication request was processed successfully.</div>
        <button class="layui-btn layui-btn-primary" onclick="redirectToLoginPage()">Back</button>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/layui/2.6.8/layui.js"></script>
    <script>

        // Global variables
        var savedLanguage = null;
        var translations = {}; // Store translations globally

        /**
     * Load translations from a local JSON file or localStorage.
     */
        async function loadTranslations() {
            const storedTranslations = localStorage.getItem('translations');
            if (storedTranslations) {
                // Use cached translations from localStorage
                translations = JSON.parse(storedTranslations);
                console.log('Translations loaded from localStorage:', translations);
            } else {
                try {
                    // Fetch translations from local JSON file
                    const response = await fetch('/locale/translation.json'); // Local JSON file in the project directory
                    if (!response.ok) throw new Error('Failed to fetch translations.');
                    translations = await response.json();
                    localStorage.setItem('translations', JSON.stringify(translations)); // Cache translations in localStorage
                    console.log('Translations loaded from local JSON file:', translations);
                } catch (error) {
                    console.error('Error loading translations:', error);

                }
            }
        }

        /**
         * Apply translations to the page based on the selected language.
         */
        function applyTranslations(language) {
            const elements = document.querySelectorAll('[data-key]');
            elements.forEach((element) => {
                const key = element.getAttribute('data-key');
                if (translations[key] && translations[key][language]) {
                    element.textContent = translations[key][language];
                }
            });
        }

        /**
         * Initialize the page: Load translations and apply the saved language.
         */
        async function initializePage() {
            await loadTranslations(); // Load translations from local JSON file or localStorage

            // Load saved language from localStorage or default to 'en'
            savedLanguage = localStorage.getItem('selectedLanguage') || 'en';

            // Pre-select the radio button based on the saved language
            const radio = document.querySelector(`input[name="language"][value="${savedLanguage}"]`);
            if (radio) {
                radio.checked = true;
            }

            // Apply translations for the saved language
            applyTranslations(savedLanguage);
        }

        /**
        * Update the selected language globally and persist it.
        */
        function updateLanguage(newLanguage) {
            savedLanguage = newLanguage; // Update global variable
            localStorage.setItem('selectedLanguage', newLanguage); // Persist to localStorage
            applyTranslations(savedLanguage); // Apply updated translations
        }

        // Initialize the page when DOM is ready
        document.addEventListener("DOMContentLoaded", initializePage);



        layui.use(['form'], function () {
            var form = layui.form;

            // Retrieve saved selection from localStorage and set the radio button
            var savedLanguage = localStorage.getItem('selectedLanguage');
            if (savedLanguage) {
                document.querySelector(`input[name="language"][value="${savedLanguage}"]`).checked = true;
                form.render('radio'); // Re-render radio buttons to apply the checked state
            }

            // Listen for language selection changes
            form.on('radio(languageRadio)', function (data) {
                console.log("Selected language:", data.value); // Logs the selected language
                localStorage.setItem('selectedLanguage', data.value); // Save selection to localStorage
                updateLanguage(data.value);
            });
        });

        async function onLogIn() {
            event.preventDefault(); // Prevent the form from refreshing the page
            layui.use('layer', async function () {

                const layer = layui.layer;
                const loading = layer.load(2); // Show loading spinner

                let email = document.getElementById('email').value;
                let password = document.getElementById('password').value;

                const payload = {
                    email: email,
                    password: password

                };




                // url = "http://192.168.29.177:8000/login"

                url = "http://192.168.0.140:8080/login"



                try {
                    // Send the POST request
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(payload)
                    });

                    // Handle the response
                    // code =1 ->success;2 -> "wrong password";
                    // 3 -> no user found;
                    // 4 -> face not register

                    if (response.ok) {
                        const data = await response.json();
                        if (data.code === "1") {
                            localStorage.setItem('email', email);
                            redirectToWelcomePage(email);

                        }
                        else if (data.code == "4") { // code = 4 face not registered
                            localStorage.setItem('email', email);
                            redirectToFaceRegistrationPage()


                        }
                        else {
                            if (data.code == "3") {
                                localStorage.setItem('email', email);
                            }
                            showErrorPage(data.message, data.code)
                        }
                    } else {
                        //  alert("Error: " + response.status);
                        showErrorPage("Error: " + response.status, "2")
                    }
                } catch (error) {
                    //   console.error('Error:', error);
                    // alert('Failed to send data');
                    console.error('Error:', error)
                    showErrorPage(error, "2")
                }
                finally {
                    layer.close(loading);
                }


            });




        }
        function validate() {
            let userName = document.getElementById("userName").value.toString();
            let password = document.getElementById("password").value.toString();
            console.log("Username: " + userName + ", Password: " + password.toString())

            if (userName === "test" && password === "test") {

                return true;
            }
            else {
                return false;
            }



        }
        function redirectToFaceRegistrationPage() {
            console.log("Redirecting...");
            window.location.href = "face_registration.html";
        }
        function redirectToFaceAuthPage() {
            console.log("Redirecting...");
            window.location.href = "face_auth.html";
        }
        function redirectToWelcomePage(username) {
            var stringToPass = username;
            window.location.href = "welcome.html?string=" + encodeURIComponent(username);
            console.log("Redirecting...");



        }

        function redirectToFaceRegistrationPage() {

            window.location.href = "face_registration.html";
            console.log("Redirecting...");



        }

        function changeButtonText(newText) {
            const button = document.getElementById("backBtn");
            if (button) {
                button.textContent = newText; // Update the button's text
            }
        }

        function redirectToRegisterPage() {
            console.log("Redirecting...");
            window.location.href = "register_user.html";

        }


        // Function to display the error page
        function showErrorPage(errorMessage, code) {

            // code 1 =success, 2 = other error, 3 = password expired
            // Hide the main content
            document.getElementById('main-content').style.display = 'none';
            // Show the error page
            const errorPage = document.getElementById('error-page');
            errorPage.style.display = 'block';
            // Set the error message dynamically
            document.getElementById('error-message').textContent = errorMessage;
            if (code === '3') {
                let newText = 'Change Password';
                const button = document.getElementById("backBtn");
                if (button) {
                    button.textContent = newText; // Update the button's text
                    button.addEventListener("click", redirectToChangePassword);
                }

            }
            else {
                let newText = 'Back';
                const button = document.getElementById("backBtn");
                if (button) {
                    button.textContent = newText; // Update the button's text
                    button.addEventListener("click", redirectToLoginPage);
                }
            }
        }

        function showSuccessMessage(successMessage) {
            document.getElementById('main-content').style.display = 'none';
            // Show the error page
            const errorPage = document.getElementById('error-page');
            errorPage.style.display = 'none';
            // Set the error message dynamically
            const successPage = document.getElementById('success-page');
            successPage.style.display = 'block';
            document.getElementById('success-message').textContent = successMessage;
        }

        function redirectToLoginPage() {
            console.log("Redirecting...");
            window.location.href = "index.html";
        }

        function redirectToChangePassword() {
            console.log("Redirecting...");
            window.location.href = "change_password.html";
        }
    </script>
</body>


</html>